---
title: 'Cluster annotation using markers from Shahan et al 2020'
author: 'WD'
output:
  html_document:
    df_print: paged
  pdf_document:
    number_sections: yes
    keep_tex: yes
---

```{r echo=FALSE, warning=FALSE}
library("SingleCellExperiment")
library("Seurat")
library("SeuratDisk")
library("tidyverse")
library("gridExtra")
library("readxl")
library("pheatmap")
```

```{r eval=FALSE, include=FALSE}
wt_denyer_markers <- readRDS("../intermediate_files/wt_cluster_DEgenes.rds")
denyer_wt <- LoadH5Seurat("../intermediate_files/denyer_wt_sctransform_clustered.h5seurat")
```

--------------------
# Manual Annotation
--------------------

We will use the markers reported in Shahan et al., 2022 (<https://doi.org/10.1016/j.devcel.2022.01.008>).


```{r}
shahan_markers <- read_excel("../data/Shahan2022/markers.xlsx", sheet = "K) Atlas_markers_1", skip=3)
```


---------------------------------------
## Annotation of the wild-type clusters
---------------------------------------


```{r}
wt_denyer_markers_filtered <- wt_denyer_markers %>%
  dplyr::filter(p_val_adj < 0.001 & avg_log2FC > 0.75) %>%
  merge(select(shahan_markers, c("cell type group", "gene")), by="gene") %>%
  rename("shahan.markers" = "cell type group")
```

---------------
Heatmap
---------------

```{r}
#turn into matrix for heatmap
heatmap_data <- wt_denyer_markers_filtered %>%
  group_by(cluster) %>%
  select(cluster, shahan.markers) %>%
  table() %>%
  as.data.frame.matrix()

#normalize counts by row (cluster)
heatmap_data_scaled <- apply(t(heatmap_data), 2, function(x){x/sum(x)}) %>% t() %>% replace(is.na(.), 0)

#plot
p1 <- pheatmap(mat = heatmap_data_scaled,
         cluster_rows = TRUE, cluster_cols = FALSE, scale="none", 
         cellwidth = 15, cellheight = 15, display_numbers = heatmap_data)
```


```{r}
#Add manual annotation
wt.new.idents <- c("Lateral root cap 1",
                   "Columella 1",
                   "Xylem pole pericycle",
                   "Columella 2",
                   "Trichoblast 1",
                   "Columella 3",
                   "Phloem pole pericycle 1",
                   "Atrichoblast 1",
                   "QC 1",
                   "Atrichoblast 2",
                   "QC 2", 
                   "Procambium",
                   "Atrichoblast 3",
                   "Phloem pole pericycle 2",
                   "Cortex",
                   "Trichoblast 2",
                   "Endodermis",
                   "Trichoblast 3",
                   "QC 3",
                   "Atrichoblast 4",
                   "Lateral root cap 2")

names(wt.new.idents) <- levels(denyer_wt@meta.data$SCT_snn_res.1.2)
denyer_wt <- RenameIdents(denyer_wt, wt.new.idents)

#Store manual annotation in metadata
denyer_wt[["Shahan.annotation.1"]] <- Idents(object = denyer_wt)

#Plot 
p2 <- DimPlot(denyer_wt, reduction="umap", label=TRUE) + theme(legend.position = "none")
p2
```

```{r}
ggsave(plot=p1, filename="./preprocessing/figures/wt_cluster_annotation_heatmap.png")
ggsave(plot=p2, filename="./preprocessing/figures/wt_cluster_annotated.png")
```

The colors represent % of the DE genes per cluster being annotates as a certain cell type. The values inside the cells are the total number of DE genes corresponding to cluster x and annotation y. 

------------------------------------------------
Subclustering vascular cell type clusters
7 (PPP 1)
11 (Procambium, pro and metaxylem)
13 (Multiple cell types)
------------------------------------------------

First combine them under the cell type vascular, then recalculate recluster and recalculate markers. Will try to overcluster and merge clusters of the same cell type after annotation. 


Will merge clusters of the poorly resolved vascular cell types and recluster

```{r}
merged.idents <- c("Lateral root cap 1",
                   "Columella 1",
                   "Vascular",
                   "Columella 2",
                   "Trichoblast 1",
                   "Columella 3",
                   "Vascular",
                   "Atrichoblast 1",
                   "QC 1",
                   "Atrichoblast 2",
                   "QC 2", 
                   "Vascular",
                   "Atrichoblast 3",
                   "Vascular",
                   "Cortex",
                   "Trichoblast 2",
                   "Endodermis",
                   "Trichoblast 3",
                   "QC 3",
                   "Atrichoblast 4",
                   "Lateral root cap 2")

names(merged.idents) <- levels(denyer_wt@meta.data$first.annotation)
denyer_wt <- RenameIdents(denyer_wt, merged.idents)
```

```{r}
DimPlot(denyer_wt, label = TRUE) + theme(legend.position = "none")
```


```{r}
# Subcluster vascular cell types
denyer_wt <- FindSubCluster(denyer_wt, cluster = "Vascular", graph.name = "SCT_snn", subcluster.name = "subclust.vascular", resolution = 1.2)

# Set Idents to subcluster identities
denyer_wt <- SetIdent(denyer_wt, value = denyer_wt@meta.data$subclust.vascular)

# Check clustering
DimPlot(denyer_wt, label = TRUE) + theme(legend.position = "none")
```

```{r}
vasculature_DEgenes <- FindAllMarkers(denyer_wt, only.pos = TRUE, logfc.threshold = 0.5)
head(vasculature_DEgenes)
```

```{r}
saveRDS(vasculature_DEgenes, file = "./vascular_clusters_DEgenes.rds")
```

Try to annotate the vascular cell types using the Shahan cell types first

```{r}
vasculature_DEgenes <- vasculature_DEgenes

vascular_markers_shahan <- vasculature_DEgenes %>%
  dplyr::filter(p_val_adj < 0.001) %>%
  merge(select(shahan_markers, c("cell type group", "gene")), by="gene") %>%
  rename("shahan.markers" = "cell type group")
```

```{r fig.width=8, fig.height=12}
#turn into matrix for heatmap
heatmap_data <- vascular_markers_shahan %>%
  filter(avg_log2FC > 0.25) %>%
  group_by(cluster) %>%
  dplyr::select(cluster, shahan.markers) %>%
  table() %>%
  as.data.frame.matrix()

#normalize counts by row (cluster)
heatmap_data_scaled <- apply(t(heatmap_data), 2, function(x){x/sum(x)}) %>% t() %>% replace(is.na(.), 0)

#plot
p3 <- pheatmap(mat = heatmap_data_scaled,
         cluster_rows = TRUE, cluster_cols = FALSE, scale="none", 
         cellwidth = 15, cellheight = 15, display_numbers = heatmap_data, main="Uncertainty in manual cluster annotation")

p3
```

Join Vascular subclusters 0, 3, 4 into LRC. 

```{r}
better.idents <- c("Atrichoblast 4", "Columella 1", "Trichoblast 2", "Trichoblast 1", "Xylem pole pericycle 1",
                   "QC 2", "QC 1", "Lateral root cap 1", "Xylem pole pericycle 4", "Columella 2", 
                   "Xylem pole pericycle 5", "Atrichoblast 1", "QC 3", "Cortex 1", "Endodermis", 
                   "Columella 3", "Cortex 2", "Atrichoblast 2", "Xylem pole pericycle 2", "Procambium 1",
                   "QC 4", "Atrichoblast 3", "Phloem pole pericycle 1", "Trichoblast 3", "Xylem pole pericycle 3",
                   "Phloem pole pericycle 2", "Procambium 2", "Protoxylem", "Lateral root cap 2")

names(better.idents) <- levels(denyer_wt)
denyer_wt <- RenameIdents(denyer_wt, better.idents)
denyer_wt[["detailed_annotation"]] <- Idents(object = denyer_wt)
```

```{r}
DimPlot(denyer_wt, label = TRUE, repel = TRUE) + theme(legend.position = "none")
```
Now merge subclusters

```{r}
better.idents <- c("Atrichoblast", "Columella", "Trichoblast", "Trichoblast", "Xylem pole pericycle", "QC",
                   "QC", "Lateral root cap",  "Xylem pole pericycle", "Columella", "Xylem pole pericycle",
                   "Atrichoblast", "QC", "Cortex", "Endodermis", "Columella", "Cortex", "Atrichoblast", "Xylem pole pericycle", "Procambium", "QC", "Atrichoblast", "Phloem pole pericycle", "Trichoblast", 
                   "Xylem pole pericycle", "Phloem pole pericycle", "Procambium", "Protoxylem", "Lateral root cap")

names(better.idents) <- levels(denyer_wt)
denyer_wt <- RenameIdents(denyer_wt, better.idents)
denyer_wt[["merged.annotation"]] <- Idents(object = denyer_wt)
```

```{r}
DimPlot(denyer_wt)
```



------------------------------------------------
Now double check cell type annotation with verified markers
------------------------------------------------

```{r}
#Load markers

verified_markers <- read_excel("../markers.xlsx")
#verified_markers <- verified_markers %>% pivot_longer(Columella:Trichoblast, names_to = "marker", values_to = "type")
#verified_markers <- verified_markers[-which(is.na(verified_markers$type)), ]
```

```{r fig.width=12, fig.height=8}
DotPlot(denyer_wt, features = graeff_markers) + theme(axis.text.x = element_text(angle = 90))
```

```{r}
ggsave(plot = p, "./preprocessing/figures/wt_annotation_dotplot.png")
```


------------------------------------------------
DE genes between clusters of the same cell type
------------------------------------------------


```{r}
SaveH5Seurat(denyer_wt, filename = "./denyer_wt_sctransform_annotated.h5seurat", overwrite = TRUE)
write_csv(better_annotation_degenes, file = "../data/annotated_DEgenes.csv")
```

The colors represent % of the DE genes per cluster being annotates as a certain cell type. The values inside the cells are the total number of DE genes corresponding to cluster x and annotation y. 

```{r}
SaveH5Seurat(object=denyer_wt, filename="../preprocessing/denyer_wt_sctransform_annotated.h5seurat")
```
